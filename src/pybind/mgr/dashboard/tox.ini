[tox]
envlist =
   clean,
   py{27,36}-{cov,lint,run,check},
   report,
skipsdist = true
minversion = 2.8.1

[pytest]
addopts =
    --cov --cov-append --cov-report=term-missing
    --doctest-modules --doctest-continue-on-failure
    --ignore=frontend/ --ignore=module.py

[testenv]
deps =
    -rrequirements.txt
    -cconstraints.txt
    cov,lint: mock
    cov: pytest<4
    cov: pytest-cov
setenv=
    PYTHONUNBUFFERED=1
    CFLAGS = -DXMLSEC_NO_SIZE_T
    UNITTEST = true
    WEBTEST_INTERACTIVE = false
    LD_LIBRARY_PATH = {toxinidir}/../../../../build/lib
    PATH = {toxinidir}/../../../../build/bin:$PATH
commands =
    cov: pytest {posargs}
    run: {posargs}
    check: python ci/check_grafana_uids.py frontend/src/app ../../../../monitoring/grafana/dashboards
depends =
    cov: clean

[testenv:report]
deps = coverage
skip_install = true
commands =
    coverage report
    coverage html
    coverage xml

[testenv:clean]
deps = coverage
skip_install = true
commands = coverage erase

[pycodestyle]
max-line-length = 100
ignore = E402, E121, E123, E126, E226, E24, E704, W503, E741
exclude = .tox, venv, frontend, .vscode
statistics = True

[pylint]
# To allow for similarity/code duplication detection
jobs = 1
dirs = . controllers plugins services tests

[testenv:lint]
deps =
    {[testenv]deps}
    pycodestyle
    pylint
skip_install = true
commands =
    pycodestyle {posargs:.}
    pylint -rn --rcfile=.pylintrc --jobs={[pylint]jobs} {posargs:{[pylint]dirs}}
